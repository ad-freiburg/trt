<html lang="en" style="font-family: Helvetica, Arial, sans-serif">
<head>
    <meta charset="utf8">
    <title>Tokenization repair</title>
</head>
<body style="width: 80%; height: 100%; margin: auto">
<br>
<h1 style="text-align: center">Tokenization repair using Transformers</h1>
<h4 style="text-align: center">Repair spurious whitespaces in text and files</h4>
<br>
<br>
<div style="width: 100%; margin: auto;">
    <label for="select_model">Select model:</label>
    <select id="select_model">
    </select>
    <p>Model description: <span id="model_description"></span></p>
    <p id="select_model_error" style="display: none; color: darkred"></p>
</div>
<br>
<section style="width: 100%; overflow: hidden">
    <h3>Upload file</h3>
    <form enctype="multipart/form-data">
        <input id="repair_file" name="file" type="file"/>
    </form>
    <p id="repair_file_error" style="display: none; color: darkred"></p>
    <h3>or input text</h3>
    <textarea id="repair_text" aria-label="repair_text"
              style="width: 100%; height: 15%; margin: auto; resize: none">Rpai rth issente nse!</textarea>

    <p id="repair_text_error" style="display: none; color: darkred"></p>
    <br>
    <br>
    <button id="repair_text_button" style="margin: auto;">Repair</button>
    <br>
    <br>
    <div id="repair_text_spinner" style="display: none">
        <img height="50px" width="50px" alt="spinner" src="spinner.gif">
    </div>
    <textarea id="repaired_text" aria-label="repaired_text" readonly
              style="width: 100%; height: 15%; margin: auto; resize: none; display: none"></textarea>
    <p id="repaired_text_runtime_container" style="display: none; font-style: italic; font-size: 80%">
        <b>Runtimes </b><span id="repaired_text_runtime"></span>
    </p>

</section>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(() => {
        let default_model;
        let model_descriptions = {};

        if (default_model === undefined) {
            let select_model_error = $("#select_model_error");
            select_model_error.hide();

            $.ajax({
                type: "GET",
                url: "http://localhost:12345/models",
                error: (_) => {
                    select_model_error.html(`error loading models, refresh page to try again`);
                    select_model_error.show();
                },
                success: (data) => {
                    default_model = data["default"];
                    let select_model = $('#select_model');
                    for (const model of data["models"]) {
                        model_descriptions[model["name"]] = model["description"];
                        select_model.append($("<option>", {
                            value: model["name"],
                            text: model["name"]
                        }));
                    }
                    select_model.trigger("change");
                }
            })
        }

        $("#select_model").on("change", () => {
            let selected_model = $("#select_model").val();
            $("#model_description").html(model_descriptions[selected_model]);
        })

        $("#repair_text_button").on("click", () => {
            let repair_text_error = $("#repair_text_error");
            repair_text_error.hide();
            let repaired_text = $("#repaired_text");
            repaired_text.hide();
            let repair_text_spinner = $("#repair_text_spinner");
            repair_text_spinner.hide();
            let repaired_text_runtime_container = $("#repaired_text_runtime_container");
            repaired_text_runtime_container.hide();

            if (default_model === undefined) {
                repair_text_error.html("models not yet loaded");
                repair_text_error.show();
                return
            }

            let repair_text = $("#repair_text").val();
            let model = $("#select_model").val();
            let start = performance.now();
            if (repair_text !== "") {
                $.ajax({
                    type: "POST",
                    url: "http://localhost:12345/repair_file?" +
                        "model=" + encodeURIComponent(model),
                    timeout: 600 * 1000,
                    data: {"text": repair_text},
                    error: (xhr) => {
                        let status_code = xhr.status;
                        let message;
                        if (status_code === 503) {
                            message = "server is overloaded, try again";
                        } else {
                            message = "unknown error";
                        }
                        repair_text_error.html(`error repairing text with status code ${status_code}: ${message}`);
                        repair_text_error.show();
                    },
                    success: (data) => {
                        let repaired_string = "";
                        for (const line of data["repaired_file"]) {
                            repaired_string += line + "\n";
                        }
                        repaired_text.val(repaired_string);
                        repaired_text.show();
                        let end = performance.now();
                        $("#repaired_text_runtime").text(
                            `Client total: ${((end - start) / 1000).toFixed(2)}s,
                            Server total: ${data["runtime"]["total"].toFixed(2)}s,
                            Server char/s: ${data["runtime"]["cps"].toFixed(2)}
                            `
                        );
                        repaired_text_runtime_container.show();
                    },
                    beforeSend: () => {
                        repair_text_spinner.show();
                    },
                    complete: () => {
                        repair_text_spinner.hide();
                    }
                })
            }
        })
        $("#repair_file").on("change", () => {
            let repair_file_error = $("#repair_file_error");
            repair_file_error.hide();

            let file_element = $("#repair_file")[0];
            if (file_element.files.length === 0) {
                return;
            }
            let file = file_element.files[0];
            if (file.type !== "text/plain") {
                repair_file_error.html(`uploaded file ${file.name} is of type ${file.type}, expected text/plain`);
                repair_file_error.show();
                return;
            }

            let file_reader = new FileReader();
            file_reader.onload = () => {
                repair_text = file_reader.result;
                $("#repair_text").val(repair_text);
            }
            file_reader.onerror = () => {
                repair_file_error.html(`error reading file ${file.name}`);
                repair_file_error.show();
            }
            file_reader.readAsText(file);
        })
    })
</script>
</body>
</html>
